# Oche — Ralph Progress Log
# Feature: oche-darts-league
# Started: 2026-01-28

## Codebase Patterns
- Use `npm run check` to run typecheck + tests before merging
- Tailwind CSS v4 uses `@import "tailwindcss"` in CSS (no directives like v3)
- Convex directory has its own tsconfig.json separate from the app
- Vitest uses jsdom environment with @testing-library/react for component tests
- Test setup file at `src/test-setup.ts` imports jest-dom matchers
- Mock Convex hooks with `vi.mock("convex/react", ...)` at module level
- Use `cleanup()` from @testing-library/react in `afterEach` to avoid duplicate DOM elements between tests
- Schema exports a default object with `.tables` property — use `Object.keys(schema.tables)` for introspection
- Blind players represented as `v.union(v.id("players"), v.literal("blind"))` in match pairings and games
- `BrowserRouter` goes in `main.tsx`, not `App.tsx` — tests use `MemoryRouter` wrapping `<App />`
- `useConvexAuth()` requires `ConvexProviderWithAuth`, not basic `ConvexProvider` — use `useAuth` hook as abstraction
- Internal nav links must use `<Link>` from react-router-dom, not `<a>` tags
- `ConvexAuthProvider` replaces `ConvexProvider` in main.tsx — wraps the entire app
- `useConvexAuth()` provides `isAuthenticated` and `isLoading` from the auth provider
- `useAuthActions()` from `@convex-dev/auth/react` provides `signIn` and `signOut`
- Auth forms use `signIn("password", formData)` with a hidden `flow` field ("signIn" or "signUp")
- `authTables` spread into schema adds 6 tables: authAccounts, authSessions, authRefreshTokens, authVerificationCodes, authVerifiers, authRateLimits
- Clear Vite dep cache (`rm -rf node_modules/.vite`) when adding packages that share peer deps like React
- OAuth providers: import from `@auth/core/providers/<name>` and add to `convexAuth({ providers: [...] })`
- Client OAuth: call `signIn("<provider>")` (lowercase) — no FormData needed for OAuth redirects
- Authorization helpers in `convex/authorization.ts` — use `requireRole(ctx.db, userId, leagueId, ["admin"])` pattern
- `auth.getUserId(ctx)` returns the auth identity ID, cast to `Id<"users">` for DB lookups
- Add `.index("by_user_league", ["userId", "leagueId"])` on leagueMemberships for efficient role lookups
- Convex `_generated/` stubs exist in `convex/_generated/` for testing — real files generated by `npx convex dev`
- Mock `../convex/_generated/api` in frontend tests that use `useQuery`/`useMutation`
- `countAdmins` helper in `authorization.ts` — use for last-admin protection checks
- Export handler functions separately from Convex wrappers (e.g., `createLeagueHandler`) for direct unit testing without auth mocking
- `leagueMemberships` index `by_user_league` supports prefix queries — omit `leagueId` to get all leagues for a user
- Use `LeagueLayout` with `<Outlet>` for league-scoped pages — provides header with switcher and breadcrumb
- League-scoped routes nest under `/leagues/:leagueId` as children of `LeagueLayout` in App.tsx
- When a component calls `useMutation` multiple times, use `mockUseMutation.mockImplementation((ref) => { ... })` dispatching on API reference string instead of `mockReturnValueOnce` chains (re-renders consume mocked values)

## 2026-01-28 - US-001
- Scaffolded Vite + React + TypeScript project
- Configured Tailwind CSS v4 with @tailwindcss/vite plugin
- Initialized Convex directory with tsconfig
- Set up Vitest with jsdom, @testing-library/react, jest-dom
- Added npm scripts: typecheck, test, test:watch, check
- **Tests added:** 2 new tests in src/App.test.tsx
- **Files changed:** 16 new files (project scaffolding)
- **Learnings for future iterations:**
  - Vite scaffolding with `npm create vite@latest` won't overwrite existing files — use a temp dir
  - Package name defaults to template name — remember to update it
  - Tailwind v4 uses `@import "tailwindcss"` instead of v3's `@tailwind` directives
  - Need `afterEach(cleanup)` in tests or DOM elements accumulate across tests
---

## 2026-01-28 - US-002
- Defined core database schema with 12 tables in `convex/schema.ts`
- Tables: users, leagues, leagueMemberships, invites, seasons, divisions, teams, players, matches, games, innings, playerStats
- Foreign keys use `v.id("tableName")`, enums use `v.union(v.literal(...))`
- **Tests added:** 2 new tests in `convex/schema.test.ts`
- **Files changed:** convex/schema.ts (new), convex/schema.test.ts (new)
- **Learnings for future iterations:**
  - Convex schema `defineSchema` returns an object with a `.tables` property that maps table names to their definitions
  - Schema tests can validate structure by checking `Object.keys(schema.tables)`
  - Match pairings use `v.union(v.id("players"), v.literal("blind"))` for blind support
---

## 2026-01-28 - US-003
- Added marketing landing page with hero, features, social proof, pricing, and footer
- Updated App.tsx to render LandingPage instead of placeholder
- Updated App tests to match new content
- **Tests added:** 6 new tests in `src/LandingPage.test.tsx`
- **Files changed:** src/LandingPage.tsx (new), src/LandingPage.test.tsx (new), src/App.tsx, src/App.test.tsx
- **Learnings for future iterations:**
  - Use `getAllByRole` + map to check multiple headings when `getByText` matches too broadly
  - Use `getByRole("heading", { name: /pattern/i })` for specific heading assertions
  - Landing page is a pure component with no backend dependencies — no mocking needed
---

## 2026-01-28 - US-004
- Added client-side routing with react-router-dom
- Header nav Log In/Sign Up use `<Link>` for SPA navigation
- Stub pages: LoginPage, SignupPage, Dashboard
- Auth redirect: authenticated users go from `/` to `/dashboard`
- Created `useAuth` hook as abstraction over Convex auth (stub for now)
- Updated all existing tests to wrap components in `MemoryRouter`
- **Tests added:** 6 new tests in `src/Navigation.test.tsx`
- **Files changed:** src/App.tsx, src/main.tsx, src/LandingPage.tsx, src/LoginPage.tsx (new), src/SignupPage.tsx (new), src/Dashboard.tsx (new), src/useAuth.tsx (new), src/Navigation.test.tsx (new), src/App.test.tsx, src/LandingPage.test.tsx
- **Learnings for future iterations:**
  - `BrowserRouter` belongs in main.tsx, not App.tsx — keeps App testable with MemoryRouter
  - `useConvexAuth()` throws if no auth provider configured — need `ConvexProviderWithAuth`
  - When multiple elements match (e.g., "OCHE" in header and footer), use `element.closest()` or `getByRole` with container
  - Convert all internal `<a href>` to `<Link to>` when adding routing
---

## 2026-01-28 - US-005
- Added email/password authentication with @convex-dev/auth
- Backend: convex/auth.ts (Password provider), convex/http.ts (HTTP routes), authTables in schema
- Frontend: LoginPage with email/password form, SignupPage with name/email/password form
- Dashboard now has Log Out button using signOut from useAuthActions
- useAuth hook wraps useConvexAuth for isAuthenticated/isLoading
- App.tsx simplified (ConvexProvider moved to main.tsx as ConvexAuthProvider)
- Password validation: minimum 8 characters enforced client-side
- Error display on login failure and signup failure
- **Tests added:** 12 new tests in src/LoginPage.test.tsx (5), src/SignupPage.test.tsx (5), src/AuthFlow.test.tsx (2)
- **Files changed:** convex/auth.ts (new), convex/http.ts (new), convex/schema.ts, convex/schema.test.ts, package.json, src/App.tsx, src/App.test.tsx, src/Dashboard.tsx, src/LoginPage.tsx, src/LoginPage.test.tsx (new), src/SignupPage.tsx, src/SignupPage.test.tsx (new), src/AuthFlow.test.tsx (new), src/Navigation.test.tsx, src/main.tsx, src/useAuth.tsx
- **Learnings for future iterations:**
  - `ConvexAuthProvider` replaces `ConvexProvider` — wraps app in main.tsx
  - `signIn("password", formData)` with hidden `flow` field distinguishes signup vs login
  - `authTables` adds 6 tables to schema — update schema tests' allowed tables list
  - Vite dep cache (`node_modules/.vite`) can cause "duplicate React" errors when adding new packages — clear it
  - `@testing-library/user-event` needed for form interaction tests (type, click)
---

## 2026-01-28 - US-006
- Added Google OAuth provider to convex/auth.ts
- Added "Sign in with Google" button with Google logo SVG on login page
- Added "or" divider between Google button and email/password form
- Tightened existing test regex from `/log in|sign in/i` to `/^log in$/i` to avoid matching Google button
- **Tests added:** 2 new tests in src/LoginPage.test.tsx (Google button render + click behavior)
- **Files changed:** convex/auth.ts, src/LoginPage.tsx, src/LoginPage.test.tsx
- **Learnings for future iterations:**
  - OAuth providers from `@auth/core/providers/` can be added directly to `convexAuth({ providers: [...] })`
  - Client calls `signIn("google")` (lowercase provider name) for OAuth redirect flow
  - Google OAuth needs `AUTH_GOOGLE_ID` and `AUTH_GOOGLE_SECRET` env vars in Convex deployment
  - When adding buttons that match existing test regexes (e.g., "Sign in with Google" vs "Log In"), tighten regexes with `^` and `$` anchors
---

## 2026-01-28 - US-007
- Added role-based authorization module (`convex/authorization.ts`) with `getMemberRole`, `requireLeagueMember`, `requireRole`
- Added `AuthorizationError` class for clear unauthorized error messages
- Added `by_user_league` index on `leagueMemberships` for efficient role lookups
- Created league management mutations (`convex/leagues.ts`) enforcing admin-only access
- Roles: Admin (full CRUD), Captain (team management), Player (read-only), Guest (non-member, public data)
- **Tests added:** 13 new tests in `convex/authorization.test.ts` (9) and `convex/leagues.test.ts` (4)
- **Files changed:** convex/authorization.ts (new), convex/authorization.test.ts (new), convex/leagues.ts (new), convex/leagues.test.ts (new), convex/schema.ts
- **Learnings for future iterations:**
  - `auth.getUserId(ctx)` returns the auth identity — needs cast to `Id<"users">` for DB operations
  - Use `requireRole(ctx.db, userId, leagueId, ["admin"])` pattern in any mutation needing role checks
  - `withIndex("by_user_league", (q) => q.eq("userId", x).eq("leagueId", y)).unique()` for membership lookups
  - Guest access = no membership record; handled by absence rather than a role value
---

## 2026-01-28 - US-008
- Added MembersPage component with role selector dropdowns for each member
- Added getMembersWithDetails query joining memberships with user details
- Added countAdmins helper and last-admin protection to updateMemberRole mutation
- Added route /leagues/:leagueId/members in App.tsx
- Created Convex _generated stubs (api.ts, dataModel.ts, server.ts) for testing without deployment
- **Tests added:** 10 new tests in convex/members.test.ts (4) and src/MembersPage.test.tsx (6)
- **Files changed:** convex/authorization.ts, convex/leagues.ts, convex/members.ts (new), convex/members.test.ts (new), convex/_generated/ (new stubs), src/MembersPage.tsx (new), src/MembersPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Convex `_generated/` directory doesn't exist without `npx convex dev` — create stub files for testing
  - `authorization.ts` only uses type imports from `_generated`, so it can be imported in tests without mocking
  - Files that import runtime values from `_generated/server` (like `query`, `mutation`) need full mocking or stubs
  - Use `vi.mock("../convex/_generated/api", ...)` in frontend tests to mock Convex API references
  - `useQuery` returns `any` with stub API — cast to typed interface for type safety
  - Route params pattern: `useParams<{ leagueId: string }>()` with `as any` cast for Convex Id types
---

## 2026-01-28 - US-009
- Added post-signup onboarding page with Create/Join league options
- League creation form with automatic admin membership assignment
- Authenticated users without leagues redirected to /onboarding, with leagues to /dashboard
- Backend: createLeague mutation + getUserLeagues query in convex/onboarding.ts
- Updated App.tsx routing with AuthenticatedRedirect component
- **Tests added:** 10 new tests: src/OnboardingPage.test.tsx (5), convex/onboarding.test.ts (3), src/Navigation.test.tsx (2 updated/added)
- **Files changed:** convex/onboarding.ts (new), convex/onboarding.test.ts (new), src/OnboardingPage.tsx (new), src/OnboardingPage.test.tsx (new), src/App.tsx, src/Navigation.test.tsx
- **Learnings for future iterations:**
  - Exported handler functions (e.g., `createLeagueHandler`) separately from Convex mutation wrappers to enable direct unit testing without mocking auth
  - `AuthenticatedRedirect` component pattern: use `useQuery` to check user state before deciding redirect target
  - When adding `useQuery` to App.tsx routing, existing Navigation tests that render `<App>` need `convex/react` mocked
  - `leagueMemberships` index `by_user_league` supports prefix queries — `q.eq("userId", x)` without `leagueId` returns all leagues for a user
---

## 2026-01-28 - US-010
- Added user dashboard displaying all leagues with role badges
- Backend: `convex/dashboard.ts` with `getUserLeaguesWithDetails` query joining memberships with league names
- Frontend: Dashboard shows league cards linking to `/leagues/:leagueId`, empty state with create/join prompts, "Create New League" button
- Updated existing AuthFlow and Navigation tests to mock new dashboard API
- **Tests added:** 9 new tests in `convex/dashboard.test.ts` (3) and `src/Dashboard.test.tsx` (6)
- **Files changed:** convex/dashboard.ts (new), convex/dashboard.test.ts (new), src/Dashboard.tsx, src/Dashboard.test.tsx (new), src/AuthFlow.test.tsx, src/Navigation.test.tsx
- **Learnings for future iterations:**
  - When a component adds `useQuery`, all test files that render it must mock `convex/react` and the API module
  - Dashboard heading changed from "Dashboard" to "My Leagues" — update any tests matching heading text
  - Use `as LeagueEntry[] | undefined` cast on `useQuery` return when `_generated/api` stubs don't provide types
  - Export handler functions (e.g., `getUserLeaguesWithDetailsHandler`) for direct unit testing without auth mocking
---

## 2026-01-28 - US-011
- Added league invitation system: generate, list, revoke, and accept invite codes
- Backend: `convex/invites.ts` with exported handler functions for unit testing
- Frontend: `src/InvitationsPage.tsx` with admin UI for managing invites
- Added schema indexes: `by_code` and `by_league` on invites table
- Added `/leagues/:leagueId/invitations` route in App.tsx
- **Tests added:** 14 new tests in `convex/invites.test.ts` (6) and `src/InvitationsPage.test.tsx` (8)
- **Files changed:** convex/invites.ts (new), convex/invites.test.ts (new), convex/schema.ts, src/InvitationsPage.tsx (new), src/InvitationsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Schema indexes need `.index("name", ["field"])` chained after `defineTable()` — add `by_code` and `by_league` for invite lookups
  - `getByText(/captain/i)` can match `<option>` elements in select dropdowns — use `getAllByText` or more specific selectors when a combobox has matching text
  - Invite codes use ambiguity-resistant characters (no 0/O/1/l/I) for readability
  - `revokeInvite` marks `used: true` rather than deleting — preserves audit trail
---

## 2026-01-28 - US-012
- Added LeagueLayout component with league switcher dropdown in the header
- League-scoped routes now nest under `/leagues/:leagueId` as children of LeagueLayout
- Active league determined by URL param; switcher navigates between leagues
- Breadcrumb link back to dashboard ("My Leagues")
- Added LeagueHome placeholder for the league index route
- **Tests added:** 6 new tests in `src/LeagueLayout.test.tsx`
- **Files changed:** src/LeagueLayout.tsx (new), src/LeagueLayout.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Use `<Outlet>` from react-router-dom inside layout components to render child routes
  - Nested routes in App.tsx: `<Route path="/leagues/:leagueId" element={<LeagueLayout />}>` with child `<Route>` elements
  - When testing layout components with nested routes, use `<Routes><Route element={<Layout />}><Route index ... /></Route></Routes>` in MemoryRouter
  - `getByRole("banner")` selects the `<header>` element — useful when text appears in both header and dropdown options
---

## 2026-01-29 - US-013
- Added CreateLeaguePage with name and description form fields
- Added `description` (optional) field to leagues schema
- Updated `createLeague` mutation to accept description
- Dashboard "Create New League" links to dedicated `/create-league` route instead of `/onboarding`
- Fixed pre-existing type-only import errors in `convex/authorization.ts`
- **Tests added:** 6 new tests in `src/CreateLeaguePage.test.tsx` (5) and `convex/onboarding.test.ts` (1)
- **Files changed:** convex/schema.ts, convex/onboarding.ts, convex/onboarding.test.ts, convex/authorization.ts, src/CreateLeaguePage.tsx (new), src/CreateLeaguePage.test.tsx (new), src/App.tsx, src/Dashboard.tsx
- **Learnings for future iterations:**
  - Reuse existing mutations (e.g., `onboarding.createLeague`) rather than creating duplicates — just extend args
  - Dashboard action links should go to dedicated pages (`/create-league`) not onboarding flow
  - Without `npx convex dev` running, auth-gated pages show empty (isLoading stays true) — browser verification of auth flows requires the Convex backend
---

## 2026-01-29 - US-014
- Added match configuration settings page at `/leagues/:leagueId/settings`
- Backend: `convex/matchConfig.ts` with admin-only `updateMatchConfig` mutation and exported handler
- Frontend: `src/MatchConfigPage.tsx` with form for all matchConfig fields (gamesPerMatch, pointsPerGameWin, bonusForTotal, extraExclude, blindRules)
- Validation: gamesPerMatch must be at least 1
- Route added to App.tsx as child of LeagueLayout
- **Tests added:** 9 new tests in `convex/matchConfig.test.ts` (3) and `src/MatchConfigPage.test.tsx` (6)
- **Files changed:** convex/matchConfig.ts (new), convex/matchConfig.test.ts (new), src/MatchConfigPage.tsx (new), src/MatchConfigPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Flatten nested config objects in mutation args (e.g., `blindEnabled` + `blindDefaultRuns` instead of nested `blindRules`) for simpler form binding
  - Use `useEffect` to sync form state from query data — avoids stale defaults when league data loads async
  - Settings pages follow same pattern as other league-scoped pages: prop `leagueId`, route wrapper in App.tsx
---

## 2026-01-29 - US-015
- Added season management: create, list, and activate seasons
- Backend: `convex/seasons.ts` with exported handler functions (createSeasonHandler, activateSeasonHandler, getSeasonsHandler)
- Frontend: `src/SeasonsPage.tsx` with create form, season list with active badge, and activate button
- Added `by_league` index on seasons table in schema
- Route: `/leagues/:leagueId/seasons` as child of LeagueLayout
- **Tests added:** 12 new tests in `convex/seasons.test.ts` (4) and `src/SeasonsPage.test.tsx` (8)
- **Files changed:** convex/seasons.ts (new), convex/seasons.test.ts (new), convex/schema.ts, src/SeasonsPage.tsx (new), src/SeasonsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - When using `mockReturnValueOnce` for `useMutation` with multiple mutations in one component, prefer `mockImplementation` that dispatches on the API reference string — avoids issues with React re-renders consuming mock values
  - `getByText(/active/i)` can match button text like "Set Active" — use `getByText(/^active$/i)` with anchors for exact badge text matching
  - Seasons table needs `by_league` index for efficient league-scoped queries
---
