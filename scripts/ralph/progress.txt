# Oche — Ralph Progress Log
# Feature: oche-darts-league
# Started: 2026-01-28

## Codebase Patterns
- Use `npm run check` to run typecheck + tests before merging
- Tailwind CSS v4 uses `@import "tailwindcss"` in CSS (no directives like v3)
- Convex directory has its own tsconfig.json separate from the app
- Vitest uses jsdom environment with @testing-library/react for component tests
- Test setup file at `src/test-setup.ts` imports jest-dom matchers
- Mock Convex hooks with `vi.mock("convex/react", ...)` at module level
- Use `cleanup()` from @testing-library/react in `afterEach` to avoid duplicate DOM elements between tests
- Schema exports a default object with `.tables` property — use `Object.keys(schema.tables)` for introspection
- Blind players represented as `v.union(v.id("players"), v.literal("blind"))` in match pairings and games
- `BrowserRouter` goes in `main.tsx`, not `App.tsx` — tests use `MemoryRouter` wrapping `<App />`
- `useConvexAuth()` requires `ConvexProviderWithAuth`, not basic `ConvexProvider` — use `useAuth` hook as abstraction
- Internal nav links must use `<Link>` from react-router-dom, not `<a>` tags
- `ConvexAuthProvider` replaces `ConvexProvider` in main.tsx — wraps the entire app
- `useConvexAuth()` provides `isAuthenticated` and `isLoading` from the auth provider
- `useAuthActions()` from `@convex-dev/auth/react` provides `signIn` and `signOut`
- Auth forms use `signIn("password", formData)` with a hidden `flow` field ("signIn" or "signUp")
- `authTables` spread into schema adds 6 tables: authAccounts, authSessions, authRefreshTokens, authVerificationCodes, authVerifiers, authRateLimits
- Clear Vite dep cache (`rm -rf node_modules/.vite`) when adding packages that share peer deps like React
- OAuth providers: import from `@auth/core/providers/<name>` and add to `convexAuth({ providers: [...] })`
- Client OAuth: call `signIn("<provider>")` (lowercase) — no FormData needed for OAuth redirects
- Authorization helpers in `convex/authorization.ts` — use `requireRole(ctx.db, userId, leagueId, ["admin"])` pattern
- `auth.getUserId(ctx)` returns the auth identity ID, cast to `Id<"users">` for DB lookups
- Add `.index("by_user_league", ["userId", "leagueId"])` on leagueMemberships for efficient role lookups
- Convex `_generated/` stubs exist in `convex/_generated/` for testing — real files generated by `npx convex dev`
- Mock `../convex/_generated/api` in frontend tests that use `useQuery`/`useMutation`
- `countAdmins` helper in `authorization.ts` — use for last-admin protection checks
- Export handler functions separately from Convex wrappers (e.g., `createLeagueHandler`) for direct unit testing without auth mocking
- `leagueMemberships` index `by_user_league` supports prefix queries — omit `leagueId` to get all leagues for a user
- Use `LeagueLayout` with `<Outlet>` for league-scoped pages — provides header with switcher and breadcrumb
- League-scoped routes nest under `/leagues/:leagueId` as children of `LeagueLayout` in App.tsx
- When a component calls `useMutation` multiple times, use `mockUseMutation.mockImplementation((ref) => { ... })` dispatching on API reference string instead of `mockReturnValueOnce` chains (re-renders consume mocked values)
- When deleting a parent entity (e.g., division), unassign child references first (e.g., clear team.divisionId) to avoid orphaned foreign keys
- Matches table has `by_league` index — use `withIndex("by_league", ...)` for league-scoped match queries
- Export pure algorithm functions separately from Convex mutations for direct unit testing without mocking
- Dual entry uses `scoreEntries` table with status state machine: pending → confirmed/discrepancy → resolved
- When adding child components with `useQuery`, update ALL parent test files' API mocks to include the new module
- Excel/CSV parsers share `ParsedScoreRow` type from `csvParser.ts` — reuse for consistent import data shape
- Google Sheets public CSV export: `https://docs.google.com/spreadsheets/d/{ID}/gviz/tq?tqx=out:csv` — reuse `parseCsvScores()` for parsing
- `ColumnMappingWizard` component: embed in any import page after file parsing — takes `headers`, `rawData`, `leagueId`, calls `onMappingComplete` with `ParseResult`
- `ImportValidationPanel` component: embed after validation — takes `ValidationResult`, `onImport`, `onCancel`; shows errors, preview, summary
- `validateImportData(parseResult, rosterNames)` validates parsed data against roster — returns `ValidationResult` with validRows, errors, counts
- `mergeParseResults(files)` merges multiple `ParseResult` arrays by player name — returns `MergeResult` with mergedRows, conflicts, errors
- Recharts for charts: mock entire module in tests with `vi.mock("recharts", ...)` returning simple divs — jsdom can't render SVG
- Convex `useQuery(ref, "skip")` skips the query — use for conditional fetching based on user selection

## 2026-01-28 - US-001
- Scaffolded Vite + React + TypeScript project
- Configured Tailwind CSS v4 with @tailwindcss/vite plugin
- Initialized Convex directory with tsconfig
- Set up Vitest with jsdom, @testing-library/react, jest-dom
- Added npm scripts: typecheck, test, test:watch, check
- **Tests added:** 2 new tests in src/App.test.tsx
- **Files changed:** 16 new files (project scaffolding)
- **Learnings for future iterations:**
  - Vite scaffolding with `npm create vite@latest` won't overwrite existing files — use a temp dir
  - Package name defaults to template name — remember to update it
  - Tailwind v4 uses `@import "tailwindcss"` instead of v3's `@tailwind` directives
  - Need `afterEach(cleanup)` in tests or DOM elements accumulate across tests
---

## 2026-01-28 - US-002
- Defined core database schema with 12 tables in `convex/schema.ts`
- Tables: users, leagues, leagueMemberships, invites, seasons, divisions, teams, players, matches, games, innings, playerStats
- Foreign keys use `v.id("tableName")`, enums use `v.union(v.literal(...))`
- **Tests added:** 2 new tests in `convex/schema.test.ts`
- **Files changed:** convex/schema.ts (new), convex/schema.test.ts (new)
- **Learnings for future iterations:**
  - Convex schema `defineSchema` returns an object with a `.tables` property that maps table names to their definitions
  - Schema tests can validate structure by checking `Object.keys(schema.tables)`
  - Match pairings use `v.union(v.id("players"), v.literal("blind"))` for blind support
---

## 2026-01-28 - US-003
- Added marketing landing page with hero, features, social proof, pricing, and footer
- Updated App.tsx to render LandingPage instead of placeholder
- Updated App tests to match new content
- **Tests added:** 6 new tests in `src/LandingPage.test.tsx`
- **Files changed:** src/LandingPage.tsx (new), src/LandingPage.test.tsx (new), src/App.tsx, src/App.test.tsx
- **Learnings for future iterations:**
  - Use `getAllByRole` + map to check multiple headings when `getByText` matches too broadly
  - Use `getByRole("heading", { name: /pattern/i })` for specific heading assertions
  - Landing page is a pure component with no backend dependencies — no mocking needed
---

## 2026-01-28 - US-004
- Added client-side routing with react-router-dom
- Header nav Log In/Sign Up use `<Link>` for SPA navigation
- Stub pages: LoginPage, SignupPage, Dashboard
- Auth redirect: authenticated users go from `/` to `/dashboard`
- Created `useAuth` hook as abstraction over Convex auth (stub for now)
- Updated all existing tests to wrap components in `MemoryRouter`
- **Tests added:** 6 new tests in `src/Navigation.test.tsx`
- **Files changed:** src/App.tsx, src/main.tsx, src/LandingPage.tsx, src/LoginPage.tsx (new), src/SignupPage.tsx (new), src/Dashboard.tsx (new), src/useAuth.tsx (new), src/Navigation.test.tsx (new), src/App.test.tsx, src/LandingPage.test.tsx
- **Learnings for future iterations:**
  - `BrowserRouter` belongs in main.tsx, not App.tsx — keeps App testable with MemoryRouter
  - `useConvexAuth()` throws if no auth provider configured — need `ConvexProviderWithAuth`
  - When multiple elements match (e.g., "OCHE" in header and footer), use `element.closest()` or `getByRole` with container
  - Convert all internal `<a href>` to `<Link to>` when adding routing
---

## 2026-01-28 - US-005
- Added email/password authentication with @convex-dev/auth
- Backend: convex/auth.ts (Password provider), convex/http.ts (HTTP routes), authTables in schema
- Frontend: LoginPage with email/password form, SignupPage with name/email/password form
- Dashboard now has Log Out button using signOut from useAuthActions
- useAuth hook wraps useConvexAuth for isAuthenticated/isLoading
- App.tsx simplified (ConvexProvider moved to main.tsx as ConvexAuthProvider)
- Password validation: minimum 8 characters enforced client-side
- Error display on login failure and signup failure
- **Tests added:** 12 new tests in src/LoginPage.test.tsx (5), src/SignupPage.test.tsx (5), src/AuthFlow.test.tsx (2)
- **Files changed:** convex/auth.ts (new), convex/http.ts (new), convex/schema.ts, convex/schema.test.ts, package.json, src/App.tsx, src/App.test.tsx, src/Dashboard.tsx, src/LoginPage.tsx, src/LoginPage.test.tsx (new), src/SignupPage.tsx, src/SignupPage.test.tsx (new), src/AuthFlow.test.tsx (new), src/Navigation.test.tsx, src/main.tsx, src/useAuth.tsx
- **Learnings for future iterations:**
  - `ConvexAuthProvider` replaces `ConvexProvider` — wraps app in main.tsx
  - `signIn("password", formData)` with hidden `flow` field distinguishes signup vs login
  - `authTables` adds 6 tables to schema — update schema tests' allowed tables list
  - Vite dep cache (`node_modules/.vite`) can cause "duplicate React" errors when adding new packages — clear it
  - `@testing-library/user-event` needed for form interaction tests (type, click)
---

## 2026-01-28 - US-006
- Added Google OAuth provider to convex/auth.ts
- Added "Sign in with Google" button with Google logo SVG on login page
- Added "or" divider between Google button and email/password form
- Tightened existing test regex from `/log in|sign in/i` to `/^log in$/i` to avoid matching Google button
- **Tests added:** 2 new tests in src/LoginPage.test.tsx (Google button render + click behavior)
- **Files changed:** convex/auth.ts, src/LoginPage.tsx, src/LoginPage.test.tsx
- **Learnings for future iterations:**
  - OAuth providers from `@auth/core/providers/` can be added directly to `convexAuth({ providers: [...] })`
  - Client calls `signIn("google")` (lowercase provider name) for OAuth redirect flow
  - Google OAuth needs `AUTH_GOOGLE_ID` and `AUTH_GOOGLE_SECRET` env vars in Convex deployment
  - When adding buttons that match existing test regexes (e.g., "Sign in with Google" vs "Log In"), tighten regexes with `^` and `$` anchors
---

## 2026-01-28 - US-007
- Added role-based authorization module (`convex/authorization.ts`) with `getMemberRole`, `requireLeagueMember`, `requireRole`
- Added `AuthorizationError` class for clear unauthorized error messages
- Added `by_user_league` index on `leagueMemberships` for efficient role lookups
- Created league management mutations (`convex/leagues.ts`) enforcing admin-only access
- Roles: Admin (full CRUD), Captain (team management), Player (read-only), Guest (non-member, public data)
- **Tests added:** 13 new tests in `convex/authorization.test.ts` (9) and `convex/leagues.test.ts` (4)
- **Files changed:** convex/authorization.ts (new), convex/authorization.test.ts (new), convex/leagues.ts (new), convex/leagues.test.ts (new), convex/schema.ts
- **Learnings for future iterations:**
  - `auth.getUserId(ctx)` returns the auth identity — needs cast to `Id<"users">` for DB operations
  - Use `requireRole(ctx.db, userId, leagueId, ["admin"])` pattern in any mutation needing role checks
  - `withIndex("by_user_league", (q) => q.eq("userId", x).eq("leagueId", y)).unique()` for membership lookups
  - Guest access = no membership record; handled by absence rather than a role value
---

## 2026-01-28 - US-008
- Added MembersPage component with role selector dropdowns for each member
- Added getMembersWithDetails query joining memberships with user details
- Added countAdmins helper and last-admin protection to updateMemberRole mutation
- Added route /leagues/:leagueId/members in App.tsx
- Created Convex _generated stubs (api.ts, dataModel.ts, server.ts) for testing without deployment
- **Tests added:** 10 new tests in convex/members.test.ts (4) and src/MembersPage.test.tsx (6)
- **Files changed:** convex/authorization.ts, convex/leagues.ts, convex/members.ts (new), convex/members.test.ts (new), convex/_generated/ (new stubs), src/MembersPage.tsx (new), src/MembersPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Convex `_generated/` directory doesn't exist without `npx convex dev` — create stub files for testing
  - `authorization.ts` only uses type imports from `_generated`, so it can be imported in tests without mocking
  - Files that import runtime values from `_generated/server` (like `query`, `mutation`) need full mocking or stubs
  - Use `vi.mock("../convex/_generated/api", ...)` in frontend tests to mock Convex API references
  - `useQuery` returns `any` with stub API — cast to typed interface for type safety
  - Route params pattern: `useParams<{ leagueId: string }>()` with `as any` cast for Convex Id types
---

## 2026-01-28 - US-009
- Added post-signup onboarding page with Create/Join league options
- League creation form with automatic admin membership assignment
- Authenticated users without leagues redirected to /onboarding, with leagues to /dashboard
- Backend: createLeague mutation + getUserLeagues query in convex/onboarding.ts
- Updated App.tsx routing with AuthenticatedRedirect component
- **Tests added:** 10 new tests: src/OnboardingPage.test.tsx (5), convex/onboarding.test.ts (3), src/Navigation.test.tsx (2 updated/added)
- **Files changed:** convex/onboarding.ts (new), convex/onboarding.test.ts (new), src/OnboardingPage.tsx (new), src/OnboardingPage.test.tsx (new), src/App.tsx, src/Navigation.test.tsx
- **Learnings for future iterations:**
  - Exported handler functions (e.g., `createLeagueHandler`) separately from Convex mutation wrappers to enable direct unit testing without mocking auth
  - `AuthenticatedRedirect` component pattern: use `useQuery` to check user state before deciding redirect target
  - When adding `useQuery` to App.tsx routing, existing Navigation tests that render `<App>` need `convex/react` mocked
  - `leagueMemberships` index `by_user_league` supports prefix queries — `q.eq("userId", x)` without `leagueId` returns all leagues for a user
---

## 2026-01-28 - US-010
- Added user dashboard displaying all leagues with role badges
- Backend: `convex/dashboard.ts` with `getUserLeaguesWithDetails` query joining memberships with league names
- Frontend: Dashboard shows league cards linking to `/leagues/:leagueId`, empty state with create/join prompts, "Create New League" button
- Updated existing AuthFlow and Navigation tests to mock new dashboard API
- **Tests added:** 9 new tests in `convex/dashboard.test.ts` (3) and `src/Dashboard.test.tsx` (6)
- **Files changed:** convex/dashboard.ts (new), convex/dashboard.test.ts (new), src/Dashboard.tsx, src/Dashboard.test.tsx (new), src/AuthFlow.test.tsx, src/Navigation.test.tsx
- **Learnings for future iterations:**
  - When a component adds `useQuery`, all test files that render it must mock `convex/react` and the API module
  - Dashboard heading changed from "Dashboard" to "My Leagues" — update any tests matching heading text
  - Use `as LeagueEntry[] | undefined` cast on `useQuery` return when `_generated/api` stubs don't provide types
  - Export handler functions (e.g., `getUserLeaguesWithDetailsHandler`) for direct unit testing without auth mocking
---

## 2026-01-28 - US-011
- Added league invitation system: generate, list, revoke, and accept invite codes
- Backend: `convex/invites.ts` with exported handler functions for unit testing
- Frontend: `src/InvitationsPage.tsx` with admin UI for managing invites
- Added schema indexes: `by_code` and `by_league` on invites table
- Added `/leagues/:leagueId/invitations` route in App.tsx
- **Tests added:** 14 new tests in `convex/invites.test.ts` (6) and `src/InvitationsPage.test.tsx` (8)
- **Files changed:** convex/invites.ts (new), convex/invites.test.ts (new), convex/schema.ts, src/InvitationsPage.tsx (new), src/InvitationsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Schema indexes need `.index("name", ["field"])` chained after `defineTable()` — add `by_code` and `by_league` for invite lookups
  - `getByText(/captain/i)` can match `<option>` elements in select dropdowns — use `getAllByText` or more specific selectors when a combobox has matching text
  - Invite codes use ambiguity-resistant characters (no 0/O/1/l/I) for readability
  - `revokeInvite` marks `used: true` rather than deleting — preserves audit trail
---

## 2026-01-28 - US-012
- Added LeagueLayout component with league switcher dropdown in the header
- League-scoped routes now nest under `/leagues/:leagueId` as children of LeagueLayout
- Active league determined by URL param; switcher navigates between leagues
- Breadcrumb link back to dashboard ("My Leagues")
- Added LeagueHome placeholder for the league index route
- **Tests added:** 6 new tests in `src/LeagueLayout.test.tsx`
- **Files changed:** src/LeagueLayout.tsx (new), src/LeagueLayout.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Use `<Outlet>` from react-router-dom inside layout components to render child routes
  - Nested routes in App.tsx: `<Route path="/leagues/:leagueId" element={<LeagueLayout />}>` with child `<Route>` elements
  - When testing layout components with nested routes, use `<Routes><Route element={<Layout />}><Route index ... /></Route></Routes>` in MemoryRouter
  - `getByRole("banner")` selects the `<header>` element — useful when text appears in both header and dropdown options
---

## 2026-01-29 - US-013
- Added CreateLeaguePage with name and description form fields
- Added `description` (optional) field to leagues schema
- Updated `createLeague` mutation to accept description
- Dashboard "Create New League" links to dedicated `/create-league` route instead of `/onboarding`
- Fixed pre-existing type-only import errors in `convex/authorization.ts`
- **Tests added:** 6 new tests in `src/CreateLeaguePage.test.tsx` (5) and `convex/onboarding.test.ts` (1)
- **Files changed:** convex/schema.ts, convex/onboarding.ts, convex/onboarding.test.ts, convex/authorization.ts, src/CreateLeaguePage.tsx (new), src/CreateLeaguePage.test.tsx (new), src/App.tsx, src/Dashboard.tsx
- **Learnings for future iterations:**
  - Reuse existing mutations (e.g., `onboarding.createLeague`) rather than creating duplicates — just extend args
  - Dashboard action links should go to dedicated pages (`/create-league`) not onboarding flow
  - Without `npx convex dev` running, auth-gated pages show empty (isLoading stays true) — browser verification of auth flows requires the Convex backend
---

## 2026-01-29 - US-014
- Added match configuration settings page at `/leagues/:leagueId/settings`
- Backend: `convex/matchConfig.ts` with admin-only `updateMatchConfig` mutation and exported handler
- Frontend: `src/MatchConfigPage.tsx` with form for all matchConfig fields (gamesPerMatch, pointsPerGameWin, bonusForTotal, extraExclude, blindRules)
- Validation: gamesPerMatch must be at least 1
- Route added to App.tsx as child of LeagueLayout
- **Tests added:** 9 new tests in `convex/matchConfig.test.ts` (3) and `src/MatchConfigPage.test.tsx` (6)
- **Files changed:** convex/matchConfig.ts (new), convex/matchConfig.test.ts (new), src/MatchConfigPage.tsx (new), src/MatchConfigPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Flatten nested config objects in mutation args (e.g., `blindEnabled` + `blindDefaultRuns` instead of nested `blindRules`) for simpler form binding
  - Use `useEffect` to sync form state from query data — avoids stale defaults when league data loads async
  - Settings pages follow same pattern as other league-scoped pages: prop `leagueId`, route wrapper in App.tsx
---

## 2026-01-29 - US-015
- Added season management: create, list, and activate seasons
- Backend: `convex/seasons.ts` with exported handler functions (createSeasonHandler, activateSeasonHandler, getSeasonsHandler)
- Frontend: `src/SeasonsPage.tsx` with create form, season list with active badge, and activate button
- Added `by_league` index on seasons table in schema
- Route: `/leagues/:leagueId/seasons` as child of LeagueLayout
- **Tests added:** 12 new tests in `convex/seasons.test.ts` (4) and `src/SeasonsPage.test.tsx` (8)
- **Files changed:** convex/seasons.ts (new), convex/seasons.test.ts (new), convex/schema.ts, src/SeasonsPage.tsx (new), src/SeasonsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - When using `mockReturnValueOnce` for `useMutation` with multiple mutations in one component, prefer `mockImplementation` that dispatches on the API reference string — avoids issues with React re-renders consuming mock values
  - `getByText(/active/i)` can match button text like "Set Active" — use `getByText(/^active$/i)` with anchors for exact badge text matching
  - Seasons table needs `by_league` index for efficient league-scoped queries
---

## 2026-01-29 - US-016
- Added division management: create, edit, delete divisions within a league
- Added team-to-division assignment UI with dropdown selectors
- Added `by_league` index on divisions table in schema
- Backend: `convex/divisions.ts` with exported handler functions (getDivisionsHandler, createDivisionHandler, editDivisionHandler, deleteDivisionHandler, assignTeamDivisionHandler, getTeamsForLeagueHandler)
- Frontend: `src/DivisionsPage.tsx` with full CRUD UI, inline editing, and team assignment
- Route: `/leagues/:leagueId/divisions` as child of LeagueLayout
- **Tests added:** 16 new tests in `convex/divisions.test.ts` (8) and `src/DivisionsPage.test.tsx` (8)
- **Files changed:** convex/schema.ts, convex/divisions.ts (new), convex/divisions.test.ts (new), convex/_generated/api.d.ts, src/DivisionsPage.tsx (new), src/DivisionsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Division names appear in both list items and `<option>` elements — use `getAllByText` instead of `getByText` when testing
  - `deleteDivision` should unassign teams (clear `divisionId`) before deleting the division to avoid orphaned references
  - `getTeamsForLeague` query added to divisions module since it's needed for the assignment UI — can be shared by future team management pages
  - `filter((q) => q.eq(q.field("leagueId"), ...))` used for teams query since teams table has no `by_league` index yet
---

## 2026-01-29 - US-017
- Added team management: create and edit teams with name, venue, and division
- Backend: `convex/teams.ts` with exported handler functions (getTeamsHandler, createTeamHandler, editTeamHandler)
- Frontend: `src/TeamsPage.tsx` with create form, team list, and inline editing
- Route: `/leagues/:leagueId/teams` as child of LeagueLayout
- **Tests added:** 13 new tests in `convex/teams.test.ts` (5) and `src/TeamsPage.test.tsx` (8)
- **Files changed:** convex/teams.ts (new), convex/teams.test.ts (new), convex/_generated/api.d.ts, src/TeamsPage.tsx (new), src/TeamsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Teams module follows same pattern as divisions: exported handler functions + Convex wrappers
  - `teams` table has no `by_league` index — uses `filter()` for league-scoped queries (consider adding index if performance becomes an issue)
  - TeamsPage reuses `api.divisions.getDivisions` query to populate the division dropdown
  - Edit form uses `startEdit(team)` pattern to pre-populate edit state from team data
---

## 2026-01-29 - US-018
- Added captain assignment: select player from roster, set as team captain
- Backend: `convex/captains.ts` with `assignCaptainHandler` and `getTeamPlayersHandler`
- Enriched `getTeamsHandler` to include `captainName` from player→user lookup
- Frontend: TeamsPage shows captain name per team, "Set Captain" button opens player picker
- Changing captain demotes old captain's membership role to "player" and promotes new one to "captain"
- **Tests added:** 8 new tests in `convex/captains.test.ts` (4) and `src/TeamsPage.test.tsx` (4)
- **Files changed:** convex/captains.ts (new), convex/captains.test.ts (new), convex/teams.ts, src/TeamsPage.tsx, src/TeamsPage.test.tsx
- **Learnings for future iterations:**
  - `captainId` is `v.id("players")` not `v.id("users")` — a player is a user on a specific team
  - When changing captains, demote old captain's `leagueMemberships` role before promoting new one
  - Enrich queries (e.g., `getTeamsHandler`) to join related data (player→user) rather than forcing multiple queries from the frontend
  - `players` table has no `by_team` index — uses `filter()` for team-scoped queries
---

## 2026-01-29 - US-019
- Added team roster management: add player by name/email, remove player, toggle active/inactive status
- Backend: `convex/roster.ts` with exported handler functions (getRosterHandler, addPlayerHandler, removePlayerHandler, setPlayerStatusHandler)
- Frontend: `src/RosterPage.tsx` with player list, status badges, add form, and action buttons
- Route: `/leagues/:leagueId/teams/:teamId/roster` as child of LeagueLayout
- Added "Roster" link on TeamsPage for each team
- Add player creates user record if email not found, and creates league membership
- Remove player clears captainId if removing the team captain
- **Tests added:** 15 new tests in `convex/roster.test.ts` (7) and `src/RosterPage.test.tsx` (8)
- **Files changed:** convex/roster.ts (new), convex/roster.test.ts (new), src/RosterPage.tsx (new), src/RosterPage.test.tsx (new), src/App.tsx, src/TeamsPage.tsx, convex/_generated/api.d.ts
- **Learnings for future iterations:**
  - `getAllByRole("button", { name: /activate/i })` matches "Activate" AND "Deactivate" — use `^activate$` anchors for exact match
  - When removing a player who is team captain, clear `team.captainId` first to avoid orphaned references
  - Roster route uses two URL params: `:leagueId` and `:teamId` — both extracted in the route wrapper
  - Add player flow: find-or-create user by email, check for existing player on team, insert player, ensure league membership
---

## 2026-01-29 - US-020
- Added manual match scheduling: create matches with home/visitor team, date, and season
- Backend: `convex/matches.ts` with exported handler functions (createMatchHandler, getMatchesHandler)
- Validation: prevents self-play and double-booking a team on the same date
- Frontend: `src/SchedulePage.tsx` with create form (team selectors, date picker) and match list
- Added `by_league` index on matches table in schema
- Route: `/leagues/:leagueId/schedule` as child of LeagueLayout
- **Tests added:** 11 new tests in `convex/matches.test.ts` (5) and `src/SchedulePage.test.tsx` (6)
- **Files changed:** convex/matches.ts (new), convex/matches.test.ts (new), convex/schema.ts, convex/_generated/api.d.ts, src/SchedulePage.tsx (new), src/SchedulePage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Team names appear in both match list and `<option>` dropdowns — use `getAllByText` instead of `getByText` in tests
  - Matches table needs `by_league` index for efficient league-scoped queries
  - Double-booking check filters existing matches by date AND checks both homeTeamId and visitorTeamId positions
  - `getMatchesHandler` enriches matches with team names by joining homeTeamId/visitorTeamId to teams table
---

## 2026-01-29 - US-021
- Added auto-generate round-robin schedule: algorithm + mutation + UI page
- Backend: `convex/scheduleGenerator.ts` with pure `generateRoundRobin()` function and `generateScheduleHandler`
- Circle method: fix one team, rotate the rest to produce N-1 rounds
- Frontend: `src/ScheduleGeneratorPage.tsx` with team checkboxes, select all/deselect all, start date, weeks between rounds
- Added "Auto-Generate" link on SchedulePage linking to `/leagues/:leagueId/schedule/generate`
- Route: `/leagues/:leagueId/schedule/generate` as child of LeagueLayout
- **Tests added:** 18 new tests in `convex/scheduleGenerator.test.ts` (10) and `src/ScheduleGeneratorPage.test.tsx` (8)
- **Files changed:** convex/scheduleGenerator.ts (new), convex/scheduleGenerator.test.ts (new), src/ScheduleGeneratorPage.tsx (new), src/ScheduleGeneratorPage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx, convex/_generated/api.d.ts
- **Learnings for future iterations:**
  - Pure algorithm functions (like `generateRoundRobin`) should be exported separately from Convex mutations for easy unit testing
  - Circle method round-robin doesn't guarantee perfect home/away balance for small N (4 teams) — some teams may have 0 home or 0 away games
  - `getByRole("button", { name: /select all/i })` matches "Deselect All" too — use `^select all$` anchors
  - Date arithmetic with `new Date(dateStr + "T00:00:00")` avoids timezone offset issues when adding days
---

## 2026-01-29 - US-022
- Added player pairings per game: assign home/visitor players or blinds to match slots
- Backend: `convex/pairings.ts` with `savePairingsHandler` (captain/admin) and `getMatchWithRostersHandler`
- Duplicate player validation (blinds exempt), active-only roster filtering
- Frontend: `src/PairingsPage.tsx` with slot-based dropdowns, add/remove slots, save button
- Added "Pairings" link on each match in SchedulePage
- Route: `/leagues/:leagueId/matches/:matchId/pairings` as child of LeagueLayout
- **Tests added:** 13 new tests in `convex/pairings.test.ts` (5) and `src/PairingsPage.test.tsx` (8)
- **Files changed:** convex/pairings.ts (new), convex/pairings.test.ts (new), convex/_generated/api.d.ts, src/PairingsPage.tsx (new), src/PairingsPage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx
- **Learnings for future iterations:**
  - Pairings are stored as an array on the `matches` table — no separate pairings table needed
  - Blind detection: check `=== "blind"` before adding to duplicate-check set
  - PairingsPage uses `useEffect` with `initialized` flag to load existing pairings from match data without re-triggering on state changes
  - Route with two params (`leagueId` + `matchId`) needs both extracted in the route wrapper component
---

## 2026-01-29 - US-023
- Added match detail page displaying teams, date, pairings with player names, game results, and totals
- Backend: `convex/matchDetail.ts` with `getMatchDetailHandler` resolving player names and fetching games
- Frontend: `src/MatchDetailPage.tsx` with sections for pairings, results, and totals
- Added "Details" link on SchedulePage for each match
- Route: `/leagues/:leagueId/matches/:matchId` as child of LeagueLayout
- **Tests added:** 11 new tests in `convex/matchDetail.test.ts` (5) and `src/MatchDetailPage.test.tsx` (6)
- **Files changed:** convex/matchDetail.ts (new), convex/matchDetail.test.ts (new), convex/_generated/api.d.ts, src/MatchDetailPage.tsx (new), src/MatchDetailPage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx
- **Learnings for future iterations:**
  - Team names appear in multiple sections (heading, totals, bonus) — use `getAllByText` instead of `getByText` in tests
  - `getMatchDetailHandler` resolves player names inline by looking up player→user chain
  - Games table has no `by_match` index — uses `filter()` for match-scoped queries (consider adding index for performance)
  - Match detail is read-only so only needs `requireLeagueMember` not `requireRole`
---

## 2026-01-29 - US-024
- Added innings score entry grid: backend mutations/queries + frontend ScoringGrid component
- Backend: `convex/scoring.ts` with `saveInningsHandler` (captain/admin) and `getGameInningsHandler`
- Frontend: `src/ScoringGrid.tsx` with 9-column grid, home/visitor rows, keyboard navigation, auto-advance
- Runs validation (0-9), delete-and-replace on re-save, arrow key/tab navigation between cells
- **Tests added:** 13 new tests in `convex/scoring.test.ts` (5) and `src/ScoringGrid.test.tsx` (8)
- **Files changed:** convex/scoring.ts (new), convex/scoring.test.ts (new), convex/_generated/api.d.ts, src/ScoringGrid.tsx (new), src/ScoringGrid.test.tsx (new)
- **Learnings for future iterations:**
  - ScoringGrid is a reusable component taking `gameId`, `leagueId`, player names — designed for embedding in match views (US-027)
  - `saveInningsHandler` deletes all existing innings for a game before inserting new ones (full replace pattern)
  - Innings table has no indexes — uses `filter()` for game-scoped queries; consider adding `by_game` index for performance
  - `type="number"` inputs use `spinbutton` role in testing-library — use `getAllByRole("spinbutton")`
  - Auto-advance: after entering a digit, focus moves to next cell; wraps from end of row to start of next row
---

## 2026-01-29 - US-025
- Added extra innings entry support to ScoringGrid component
- "Add Extra Inning" button appears when regulation innings (1-9) result in a tie
- Extra inning columns render with amber background/border styling and E1/E2/etc headers
- Extra innings saved with `isExtra: true` flag in database
- No limit on number of extra innings; loads existing extras from data
- **Tests added:** 6 new tests in `convex/scoring.test.ts` (1) and `src/ScoringGrid.test.tsx` (5)
- **Files changed:** src/ScoringGrid.tsx, src/ScoringGrid.test.tsx, convex/scoring.test.ts
- **Learnings for future iterations:**
  - ScoringGrid uses `extraCount` state to track number of extra columns — grid array is dynamically resized
  - Tie detection: sum all 9 regulation innings for each side, compare totals (all must be filled)
  - Extra inning headers use "E1", "E2" etc. format to distinguish from regulation innings
  - Input refs array must be resized when extra innings are added for keyboard navigation to work
  - Existing extra innings loaded by checking `isExtra` flag and computing column offset from `inningNumber - REGULATION_INNINGS`
---

## 2026-01-29 - US-026
- Added auto-calculated Plus, Minus, and Total columns to ScoringGrid component
- Plus = sum of own regulation batting runs (innings 1-9), Minus = sum of opponent's regulation runs, Total = Plus - Minus
- Extra innings excluded from all calculations via `useMemo` computing only columns 0-8
- Columns update in real-time as runs are entered (reactive via grid state dependency)
- **Tests added:** 6 new tests in `src/ScoringGrid.test.tsx`
- **Files changed:** src/ScoringGrid.tsx, src/ScoringGrid.test.tsx
- **Learnings for future iterations:**
  - ScoringGrid totals are computed via `useMemo` depending on `grid` state — no backend calculation needed
  - Use `data-testid` attributes for totals cells since text content (numbers) is ambiguous with inning headers
  - Plus/Minus/Total columns are read-only `<td>` elements, not inputs — they follow the inning input columns
---

## 2026-01-29 - US-027
- Added multi-game match score entry page at `/leagues/:leagueId/matches/:matchId/score`
- MatchScoreEntryPage composes multiple ScoringGrid instances — one per game in the match
- Games displayed with slot numbers and player names, collapse/expand toggle per game
- Overall match totals section at bottom (reads from match.totals if available)
- Added "Scores" link on SchedulePage for each match
- Reuses existing `matchDetail.getMatchDetail` query — no new backend code needed
- **Tests added:** 8 new tests in `src/MatchScoreEntryPage.test.tsx`
- **Files changed:** src/MatchScoreEntryPage.tsx (new), src/MatchScoreEntryPage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx
- **Learnings for future iterations:**
  - MatchScoreEntryPage is a pure composition layer — each ScoringGrid handles its own data fetching, so no aggregate query was needed
  - Player names appear in both the collapsible header button and the ScoringGrid row — use `getAllByText` in tests
  - Pairing data is mapped by slot number for O(1) lookup when rendering game headers
  - Collapse state uses a `Set<string>` of game IDs — toggling creates a new Set for immutable state updates
---

## 2026-01-29 - US-028
- Added game winner determination: pure function + Convex mutation
- `determineGameWinner()` sums all innings (regulation + extra) to determine winner
- `determineWinnerHandler` reads innings from DB, computes winner, patches game record
- Winner field: "home" | "visitor" | "tie"; null if no innings data
- **Tests added:** 8 new tests in `convex/gameWinner.test.ts`
- **Files changed:** convex/gameWinner.ts (new), convex/gameWinner.test.ts (new)
- **Learnings for future iterations:**
  - Game winner uses total runs (regulation + extras combined) — not just regulation
  - Export pure `determineGameWinner` separately from handler for direct unit testing
  - `db.patch()` used to update existing game record with winner field
---

## 2026-01-29 - US-029
- Added DNP (Did Not Play) toggle and blind score auto-population
- Backend: `convex/dnpBlind.ts` with `toggleDnpHandler` and `applyBlindScoresHandler`
- Added `isDnp` optional boolean field to `games` table schema
- DNP toggle clears winner field; undoing DNP restores ability to score
- Blind auto-scoring reads `league.matchConfig.blindRules.defaultRuns` for fixed-value blind innings
- Frontend: MatchScoreEntryPage shows DNP button per game, "(Blind)" label, grayed-out DNP games with "No Points" text
- **Tests added:** 11 new tests in `convex/dnpBlind.test.ts` (6) and `src/MatchScoreEntryPage.dnp.test.tsx` (5)
- **Files changed:** convex/schema.ts, convex/dnpBlind.ts (new), convex/dnpBlind.test.ts (new), src/MatchScoreEntryPage.tsx, src/MatchScoreEntryPage.test.tsx, src/MatchScoreEntryPage.dnp.test.tsx (new), convex/_generated/api.d.ts
- **Learnings for future iterations:**
  - Convex `v.optional(v.boolean())` for the `isDnp` field — clearing winner uses `undefined` not `null` (Convex doesn't allow null in patches for optional fields)
  - When adding `useMutation` for a new module in a component, ALL test files rendering that component must add the new API module to their mock
  - `/blind/i` regex in tests matches both player name "Blind" and "(Blind)" label — use exact string match `"(Blind)"` for the label
  - `applyBlindScores` inserts 18 innings (9 for each batter) — blind side gets `defaultRuns`, real side gets 0 as placeholder
---
## 2026-01-29 - US-030
- Added visual highlighting for 9-run innings: yellow background + bold text + `data-high-inning` attribute
- Added "9s" column to ScoringGrid showing high innings count per player
- High innings count computed via `useMemo` from grid state — reactive, no backend needed
- `playerStats.highInnings` field already exists in schema for US-039 to populate
- **Tests added:** 4 new tests in `src/ScoringGrid.test.tsx`
- **Files changed:** src/ScoringGrid.tsx, src/ScoringGrid.test.tsx
- **Learnings for future iterations:**
  - Use `data-*` attributes for programmatic detection of visual states in tests (e.g., `data-high-inning`)
  - `input.closest("td")` in tests to check parent cell attributes/styling
  - `useMemo` with `totalColumns` dependency ensures high innings count includes extra innings
---

## 2026-01-29 - US-031
- Added dual score entry system: both captains submit independently, system compares inning-by-inning
- Backend: `convex/dualEntry.ts` with `submitScoreEntryHandler`, `getScoreEntriesHandler`, `resolveDiscrepancyHandler`, and pure `compareScoreEntries` function
- Added `scoreEntries` table to schema with gameId, side, submittedBy, innings array, and status fields
- Auto-confirms when both entries match; flags discrepancy when they differ
- Admin resolution: choose one side's entry or provide corrected innings
- Frontend: `src/DiscrepancyReviewPage.tsx` shows both entries side-by-side with highlighted differences
- Frontend: `src/DualEntryStatus.tsx` shows per-game dual entry status on match score entry page
- Route: `/leagues/:leagueId/matches/:matchId/games/:gameId/review` for admin resolution
- **Tests added:** 19 new tests in `convex/dualEntry.test.ts` (11) and `src/DiscrepancyReviewPage.test.tsx` (8)
- **Files changed:** convex/dualEntry.ts (new), convex/dualEntry.test.ts (new), convex/schema.ts, convex/schema.test.ts, convex/_generated/api.d.ts, src/DiscrepancyReviewPage.tsx (new), src/DiscrepancyReviewPage.test.tsx (new), src/DualEntryStatus.tsx (new), src/App.tsx, src/MatchScoreEntryPage.tsx, src/MatchScoreEntryPage.test.tsx, src/MatchScoreEntryPage.dnp.test.tsx
- **Learnings for future iterations:**
  - When adding a new `useQuery` call via a child component (e.g., DualEntryStatus), ALL test files rendering the parent must update their API mock to include the new module
  - Mock `withIndex` in test db helpers needs to capture `eq()` calls and filter properly — returning `rows[0]` silently breaks role checks for non-first memberships
  - `compareScoreEntries` is a pure function — easy to test without any DB mocking
  - Score entries use a "pending → confirmed/discrepancy → resolved" state machine
---

## 2026-01-29 - US-032
- Made ScoringGrid tablet-friendly: touch targets ≥44px, `inputmode="numeric"`, `touch-action: manipulation`
- Added `touch-action-manipulation` custom Tailwind v4 utility in index.css
- Real-time sync already provided by Convex `useQuery` subscriptions — no backend changes needed
- **Tests added:** 5 new tests in `src/ScoringGrid.tablet.test.tsx`
- **Files changed:** src/ScoringGrid.tsx, src/ScoringGrid.tablet.test.tsx (new), src/index.css
- **Learnings for future iterations:**
  - Convex `useQuery` is subscription-based — all viewers auto-receive updates when any user calls `useMutation`, no additional real-time code needed
  - Tailwind CSS v4 custom utilities use `@utility name { ... }` syntax in the CSS file
  - Use `inputmode="numeric"` (not `type="number"`) for mobile numeric keyboards without spinner buttons
  - `min-h-[44px]` ensures WCAG/Apple HIG minimum touch target size
---

## 2026-01-29 - US-033
- Added CSV file upload page with PapaParse parsing and preview table
- Pure `parseCsvScores()` utility validates runs 0-9, requires 9 innings, trims whitespace
- Frontend: `CsvUploadPage` with file input (.csv only), error display, preview table, import button
- Route: `/leagues/:leagueId/matches/:matchId/import-csv` as child of LeagueLayout
- Added "Import CSV" link on SchedulePage per match
- **Tests added:** 10 new tests in `src/csvParser.test.ts` (5) and `src/CsvUploadPage.test.tsx` (5)
- **Files changed:** package.json, src/csvParser.ts (new), src/csvParser.test.ts (new), src/CsvUploadPage.tsx (new), src/CsvUploadPage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx
- **Learnings for future iterations:**
  - PapaParse runs client-side — parse CSV in the browser, send structured data to Convex mutations
  - `getByText(/csv/i)` matches multiple elements (heading + label) — use `getByRole("heading", { name: /csv/i })` for specificity
  - `FileReader.readAsText()` in `fireEvent.change` tests requires `waitFor` since reading is async
  - CSV parser is a pure function with no Convex dependencies — easy to test without DB mocking
---

## 2026-01-29 - US-034
- Added Excel file upload page with SheetJS parsing (.xlsx/.xls)
- Pure `parseExcelScores()` utility validates runs 0-9, requires 9 innings, returns sheet names
- Sheet selector dropdown for multi-sheet workbooks
- Frontend: `ExcelUploadPage` with file input, sheet selector, error display, preview table, import button
- Route: `/leagues/:leagueId/matches/:matchId/import-excel` as child of LeagueLayout
- Added "Import Excel" link on SchedulePage per match
- **Tests added:** 11 new tests in `src/excelParser.test.ts` (5) and `src/ExcelUploadPage.test.tsx` (6)
- **Files changed:** package.json, src/excelParser.ts (new), src/excelParser.test.ts (new), src/ExcelUploadPage.tsx (new), src/ExcelUploadPage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx
- **Learnings for future iterations:**
  - SheetJS `XLSX.read(data, { type: "array" })` parses ArrayBuffer from `FileReader.readAsArrayBuffer()`
  - `XLSX.utils.sheet_to_json(ws, { header: 1 })` returns raw 2D array (no header mapping) — matches CSV parser pattern
  - Excel parser reuses `ParsedScoreRow` type from csvParser for consistent data shape across import formats
  - Mock `xlsx` module and `./excelParser` separately in component tests — avoids needing real binary parsing in jsdom
  - `FileReader.readAsArrayBuffer()` (not `readAsText`) for Excel binary files
---

## 2026-01-29 - US-035
- Added Google Sheets import page: paste public sheet URL, fetch as CSV, preview, import
- Pure `googleSheetsParser.ts` utility: extract sheet ID from URLs, build CSV export URL
- Uses Google's public CSV export endpoint (`/gviz/tq?tqx=out:csv`) — no API key or OAuth token needed
- Reuses existing `parseCsvScores()` from csvParser for parsing fetched CSV data
- Route: `/leagues/:leagueId/matches/:matchId/import-gsheets` as child of LeagueLayout
- Added "Import Google Sheets" link on SchedulePage per match
- **Tests added:** 16 new tests in `src/googleSheetsParser.test.ts` (10) and `src/GoogleSheetsImportPage.test.tsx` (6)
- **Files changed:** src/googleSheetsParser.ts (new), src/googleSheetsParser.test.ts (new), src/GoogleSheetsImportPage.tsx (new), src/GoogleSheetsImportPage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx
- **Learnings for future iterations:**
  - Google Sheets public CSV export URL pattern: `https://docs.google.com/spreadsheets/d/{ID}/gviz/tq?tqx=out:csv&sheet={SHEET}` — works for sheets shared with "Anyone with the link"
  - Reusing `parseCsvScores()` for Google Sheets avoids duplicating parsing logic — the CSV export format is standard
  - `global.fetch = vi.fn()` in tests to mock fetch for URL-based data fetching
  - Sheet ID regex: `/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/` handles edit, view, and gid URL variants
---

## 2026-01-29 - US-036
- Added column mapping wizard: auto-detect columns, manual mapping, preview, confirm, save/load templates
- Pure logic: `src/columnMapper.ts` with `autoDetectMapping()` and `applyColumnMapping()` functions
- Component: `src/ColumnMappingWizard.tsx` with step-by-step UI (map → preview → confirm)
- Backend: `convex/importTemplates.ts` for saving/loading mapping templates per league
- Added `importTemplates` table to schema
- Auto-detection recognizes: Player/Name/Shooter, numbered innings (1-9, Inning 1-9), Plus, Minus
- **Tests added:** 20 new tests in `src/columnMapper.test.ts` (10), `src/ColumnMappingWizard.test.tsx` (8), `convex/importTemplates.test.ts` (2)
- **Files changed:** src/columnMapper.ts (new), src/columnMapper.test.ts (new), src/ColumnMappingWizard.tsx (new), src/ColumnMappingWizard.test.tsx (new), convex/importTemplates.ts (new), convex/importTemplates.test.ts (new), convex/schema.ts, convex/schema.test.ts
- **Learnings for future iterations:**
  - Column mapping is a pure data transformation — separate `autoDetectMapping` and `applyColumnMapping` from React/Convex for testability
  - `ColumnMappingWizard` is a reusable component that any import page can embed after file parsing
  - Use `mockUseQuery` / `mockUseMutation` pattern (not `require("convex/react")`) for component tests
  - `importTemplates` table stores mappings per league — templates are league-scoped
---

## 2026-01-29 - US-037
- Added import validation with roster-aware player name matching (case-insensitive)
- Pure `validateImportData()` function validates runs 0-9, required innings, and roster membership
- `ImportValidationPanel` component displays row-level errors, valid row preview, and import/skip summary
- Parse-level errors from CSV/Excel parsers forwarded into validation results
- Import button shows count and disables when no valid rows
- **Tests added:** 16 new tests in `src/importValidator.test.ts` (8) and `src/ImportValidationPanel.test.tsx` (8)
- **Files changed:** src/importValidator.ts (new), src/importValidator.test.ts (new), src/ImportValidationPanel.tsx (new), src/ImportValidationPanel.test.tsx (new)
- **Learnings for future iterations:**
  - `ImportValidationPanel` is a reusable component — embed after parsing in any import page, pass `ValidationResult` + callbacks
  - `validateImportData` takes `ParseResult` + roster names array — keeps validation decoupled from data source
  - Case-insensitive roster matching via `toLowerCase()` prevents false negatives from capitalization differences
  - `skippedCount` includes both validation-rejected rows AND parse-level errors for accurate totals
---

## 2026-01-29 - US-038
- Added multi-file merge: upload multiple CSV files, merge by player, detect and resolve conflicts
- Pure `mergeParseResults()` function groups rows by normalized player name, auto-merges identical data, flags conflicts
- Pure `resolveConflict()` function resolves by selecting an entry or providing custom innings
- Frontend: `MultiFileMergePage` with file upload list, merge button, conflict resolution UI, merged preview table
- Route: `/leagues/:leagueId/matches/:matchId/import-merge` as child of LeagueLayout
- Added "Merge Files" link on SchedulePage per match
- **Tests added:** 15 new tests in `src/fileMerger.test.ts` (8) and `src/MultiFileMergePage.test.tsx` (7)
- **Files changed:** src/fileMerger.ts (new), src/fileMerger.test.ts (new), src/MultiFileMergePage.tsx (new), src/MultiFileMergePage.test.tsx (new), src/App.tsx, src/SchedulePage.tsx
- **Learnings for future iterations:**
  - Merge logic is a pure function with no Convex dependencies — easy to test without DB mocking
  - Case-insensitive player matching via `toLowerCase().trim()` for merge grouping
  - `JSON.stringify` comparison for detecting identical innings arrays across files
  - FileReader mock in tests: use `vi.spyOn(FileReader.prototype, "readAsText")` with `setTimeout` to simulate async read
  - Reset file input with `e.target.value = ""` after reading to allow re-adding the same file
---

## 2026-01-29 - US-039
- Added player statistics calculation: pure function + Convex mutation/query
- Pure `calculatePlayerStats()` computes: gamesPlayed, wins, losses, totalPlus, totalMinus, highInnings
- Extra innings excluded from all calculations (plus, minus, high innings)
- `recalculatePlayerStatsHandler` reads all games/innings for a player in a season, computes stats, upserts to playerStats table
- `getPlayerStatsHandler` retrieves stored stats for a player/season
- **Tests added:** 9 new tests in `convex/playerStats.test.ts`
- **Files changed:** convex/playerStats.ts (new), convex/playerStats.test.ts (new)
- **Learnings for future iterations:**
  - Player stats are derived data — pure calculation function takes `GameData[]` and returns stats, no DB needed for computation
  - "Plus" = own regular batting runs, "Minus" = opponent's regular batting runs — both exclude extra innings
  - High innings count only includes 9-run regular (non-extra) innings
  - DNP games are skipped entirely in stat calculations
  - Upsert pattern: query for existing playerStats record by playerId+seasonId, patch if found, insert if not
---

## 2026-01-29 - US-040
- Added player stats page with summary stats, season selector, and game-by-game history table
- Backend: `convex/playerStatsPage.ts` with `getPlayerPageDataHandler` computing stats + game history
- Frontend: `src/PlayerStatsPage.tsx` with stat cards, season dropdown, and history table with result badges
- Route: `/leagues/:leagueId/players/:playerId/stats` as child of LeagueLayout
- Season ID is optional in query — defaults to active season when not specified
- **Tests added:** 12 new tests in `convex/playerStatsPage.test.ts` (5) and `src/PlayerStatsPage.test.tsx` (7)
- **Files changed:** convex/playerStatsPage.ts (new), convex/playerStatsPage.test.ts (new), src/PlayerStatsPage.tsx (new), src/PlayerStatsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Make seasonId optional in queries that need a season selector — default to active season server-side
  - Game history requires traversing matches → games → innings per player — consider adding indexes if performance becomes an issue
  - `average` is a derived stat (totalPlus / gamesPlayed) — compute it in the query rather than storing it
  - Use `vi.fn()` directly in `vi.mock("convex/react", ...)` and import+cast after for TypeScript compatibility
---

## 2026-01-29 - US-041
- Added team statistics page: aggregate stats (game wins, runs scored/allowed, match points, plus/minus) and roster with per-player stats
- Backend: `convex/teamStats.ts` with `getTeamStatsHandler` aggregating from matches, games, innings, and playerStats tables
- Frontend: `src/TeamStatsPage.tsx` with stat cards, season selector, and roster table
- Added "Stats" link on TeamsPage for each team
- Route: `/leagues/:leagueId/teams/:teamId/stats` as child of LeagueLayout
- **Tests added:** 11 new tests in `convex/teamStats.test.ts` (5) and `src/TeamStatsPage.test.tsx` (6)
- **Files changed:** convex/teamStats.ts (new), convex/teamStats.test.ts (new), src/TeamStatsPage.tsx (new), src/TeamStatsPage.test.tsx (new), src/App.tsx, src/TeamsPage.tsx, convex/_generated/api.d.ts
- **Learnings for future iterations:**
  - Team stats aggregate across all matches where the team is home or visitor — use `isHome` flag to determine which side's innings to count as "scored" vs "allowed"
  - Match points = (game wins × pointsPerGameWin) + bonus points from match.totals.bonusWinner
  - Roster stats come from `playerStats` table (pre-computed per player/season) — no need to re-aggregate from innings
  - `getAllByText` needed when stat values appear in both team stat cards and per-player roster table
---

## 2026-01-29 - US-042
- Added league standings page: standings table sorted by match points with tiebreakers
- Backend: `convex/standings.ts` with `getStandingsHandler` aggregating all teams in a league
- Tiebreaker order: match points → total runs scored → plus/minus (head-to-head omitted for simplicity)
- Division and season filtering via query args
- Frontend: `src/StandingsPage.tsx` with standings table, season selector, division filter
- Route: `/leagues/:leagueId/standings` as child of LeagueLayout
- **Tests added:** 11 new tests in `convex/standings.test.ts` (5) and `src/StandingsPage.test.tsx` (6)
- **Files changed:** convex/standings.ts (new), convex/standings.test.ts (new), src/StandingsPage.tsx (new), src/StandingsPage.test.tsx (new), src/App.tsx, convex/_generated/api.d.ts
- **Learnings for future iterations:**
  - Standings query reuses same aggregation pattern as `getTeamStatsHandler` but for all teams at once
  - Pre-fetch all games and innings for season matches to avoid N+1 queries per team
  - Head-to-head tiebreaker would require per-pair aggregation — skipped in favor of runs scored and plus/minus
  - `font-variant-numeric: tabular-nums` ensures columns of numbers align properly in standings table
---

## 2026-01-29 - US-043
- Added player leaderboards page with 5 categories: highest average, most runs, best plus/minus, most high innings, most wins
- Backend: `convex/leaderboards.ts` with `getLeaderboardsHandler` reading from `playerStats` table
- Frontend: `src/LeaderboardsPage.tsx` with category cards in 2-column grid, season selector
- Top 10 per category, sorted descending by each metric
- Route: `/leagues/:leagueId/leaderboards` as child of LeagueLayout
- **Tests added:** 11 new tests in `convex/leaderboards.test.ts` (5) and `src/LeaderboardsPage.test.tsx` (6)
- **Files changed:** convex/leaderboards.ts (new), convex/leaderboards.test.ts (new), src/LeaderboardsPage.tsx (new), src/LeaderboardsPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Leaderboards read from pre-computed `playerStats` table rather than re-aggregating from innings — much more efficient
  - Filter league players by checking if their team exists in the league's teams (via teamMap)
  - Average is computed as `totalPlus / gamesPlayed` with rounding to 1 decimal place
  - Player names appear in multiple categories — use `getAllByText` in frontend tests
---

## 2026-01-29 - US-044
- Added historical trends page with Recharts line charts for player averages and team points over time
- Backend: `convex/trends.ts` with `getTrendsMetadataHandler`, `getPlayerTrendHandler`, `getTeamTrendHandler`
- Frontend: `src/HistoricalTrendsPage.tsx` with mode toggle (players/teams), up to 3 entity comparison, season selector
- Player trends show cumulative average per match date; team trends show cumulative match points
- Installed `recharts` library for chart rendering
- Route: `/leagues/:leagueId/trends` as child of LeagueLayout
- **Tests added:** 14 new tests in `convex/trends.test.ts` (6) and `src/HistoricalTrendsPage.test.tsx` (8)
- **Files changed:** convex/trends.ts (new), convex/trends.test.ts (new), src/HistoricalTrendsPage.tsx (new), src/HistoricalTrendsPage.test.tsx (new), src/App.tsx, package.json
- **Learnings for future iterations:**
  - Mock `recharts` in frontend tests to avoid SVG rendering issues in jsdom — replace with simple divs using `data-testid`
  - Recharts `ResponsiveContainer` needs a parent with explicit height (`h-80`) to render
  - Use `Record<string, string | number>` for chart data objects that have a string `date` field plus numeric data fields
  - Convex `useQuery` with `"skip"` argument skips the query entirely — use for conditional fetching based on selection state
  - Limit comparison to 3 entities to keep charts readable and avoid excessive queries
---

## 2026-01-29 - US-045
- Added CSV and PDF export for league standings and player statistics
- Backend: `convex/statsExport.ts` with `getExportDataHandler` returning enriched player stats
- Frontend: `src/statsExport.ts` pure utility functions for CSV generation and PDF generation (jsPDF + jspdf-autotable)
- Frontend: `src/PlayerStatsExportPage.tsx` with season selector, stats table, export buttons
- Export buttons added to `StandingsPage` for standings CSV/PDF
- Route: `/leagues/:leagueId/player-stats-export` as child of LeagueLayout
- Installed `jspdf` and `jspdf-autotable` for PDF generation
- **Tests added:** 19 new tests in `src/statsExport.test.ts` (6), `src/StandingsPage.test.tsx` (4), `src/PlayerStatsExportPage.test.tsx` (6), `convex/statsExport.test.ts` (3)
- **Files changed:** convex/statsExport.ts (new), convex/statsExport.test.ts (new), src/statsExport.ts (new), src/statsExport.test.ts (new), src/PlayerStatsExportPage.tsx (new), src/PlayerStatsExportPage.test.tsx (new), src/StandingsPage.tsx, src/StandingsPage.test.tsx, src/App.tsx, package.json
- **Learnings for future iterations:**
  - CSV export is best done client-side with `Blob` + `URL.createObjectURL` — no server-side generation needed
  - jsPDF with jspdf-autotable provides table formatting in PDFs — use dynamic import to keep it out of initial bundle
  - `downloadCsv` helper creates a temporary `<a>` element with download attribute for browser file download
  - CSV field escaping: wrap in quotes if field contains commas, quotes, or newlines; double-escape internal quotes
  - Reuse existing query data from `useQuery` for export — no need for separate export-specific mutations
---

## 2026-01-29 - US-046
- Added handicap configuration page: enable/disable, percentage, recalculation frequency
- Backend: `convex/handicapConfig.ts` with `updateHandicapConfigHandler` (admin-only)
- Frontend: `src/HandicapConfigPage.tsx` with form for all handicap settings
- Schema: added `handicapRecalcFrequency` to leagues, optional `handicapPercent` to matches and games for per-match/per-game overrides
- Route: `/leagues/:leagueId/handicap` as child of LeagueLayout
- **Tests added:** 9 new tests in `convex/handicapConfig.test.ts` (3) and `src/HandicapConfigPage.test.tsx` (6)
- **Files changed:** convex/schema.ts, convex/handicapConfig.ts (new), convex/handicapConfig.test.ts (new), convex/_generated/api.d.ts, src/HandicapConfigPage.tsx (new), src/HandicapConfigPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Three-tier handicap override pattern: league default → per-match → per-game via optional `handicapPercent` on matches and games tables
  - `handicapRecalcFrequency` uses union type: "weekly" | "per-match" | "manual"
  - Handicap percentage validation: 0-100 range enforced in handler
  - Schema already had `handicapEnabled` and `handicapPercent` on leagues — only needed to add `handicapRecalcFrequency` and override fields
---

## 2026-01-29 - US-047
- Added handicap scoring: pure functions for spot runs computation, cascading percent resolution, and handicapped winner determination
- Backend: `convex/handicapScoring.ts` with `computeSpotRuns`, `resolveHandicapPercent`, `determineHandicappedWinner` pure functions, and `getGameHandicapHandler` query
- Frontend: ScoringGrid shows handicap info bar (spot runs, recipient, averages) and "Adj" column with adjusted totals
- Three-tier cascading: league default → per-match override → per-game override via `resolveHandicapPercent`
- Blind games excluded from handicap (no averages to compare)
- Raw stats preserved — handicap only affects adjusted totals display and winner determination
- **Tests added:** 17 new tests in `convex/handicapScoring.test.ts` (13) and `src/ScoringGrid.handicap.test.tsx` (4)
- **Files changed:** convex/handicapScoring.ts (new), convex/handicapScoring.test.ts (new), src/ScoringGrid.tsx, src/ScoringGrid.handicap.test.tsx (new), src/ScoringGrid.test.tsx, src/ScoringGrid.tablet.test.tsx, src/MatchScoreEntryPage.test.tsx, src/MatchScoreEntryPage.dnp.test.tsx
- **Learnings for future iterations:**
  - When adding `useQuery` to ScoringGrid, ALL test files rendering ScoringGrid or its parent (MatchScoreEntryPage) need the new API module in their mock
  - `handicapData && handicapData.spotRuns > 0` pattern safely handles null/undefined/zero — existing tests return `[]` from mockUseQuery which has no `spotRuns`
  - Pure functions for handicap math (computeSpotRuns, resolveHandicapPercent, determineHandicappedWinner) enable easy testing without DB
  - Cascading override pattern: game > match > league — resolved with simple `undefined` checks
---

## 2026-01-29 - US-048
- Added payment configuration page: league fee, weekly fee, and fee schedule settings
- Backend: `convex/paymentConfig.ts` with `updatePaymentConfigHandler` (admin-only)
- Frontend: `src/PaymentConfigPage.tsx` with form for all payment settings
- Schema: added `leagueFee`, `weeklyFee`, `feeSchedule` optional fields to leagues table
- Route: `/leagues/:leagueId/payments` as child of LeagueLayout
- **Tests added:** 9 new tests in `convex/paymentConfig.test.ts` (3) and `src/PaymentConfigPage.test.tsx` (6)
- **Files changed:** convex/schema.ts, convex/paymentConfig.ts (new), convex/paymentConfig.test.ts (new), convex/_generated/api.d.ts, src/PaymentConfigPage.tsx (new), src/PaymentConfigPage.test.tsx (new), src/App.tsx
- **Learnings for future iterations:**
  - Payment config follows exact same pattern as handicap config — admin-only mutation with exported handler, form page with useEffect sync
  - Fee fields are optional on leagues table (existing leagues don't have them) — defaults to 0 in frontend via `?? 0`
  - `feeSchedule` uses union type: "one-time" | "weekly" | "per-match"
---
